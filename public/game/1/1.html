<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星際保衛者</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #0a0a2a, #000033);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
            max-width: 1200px;
            padding: 15px;
            background: rgba(10, 10, 40, 0.8);
            border-radius: 15px;
            border: 2px solid #00a8ff;
            box-shadow: 0 0 20px rgba(0, 168, 255, 0.3);
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #00a8ff, #9c88ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
        }

        .header p {
            font-size: 1.1rem;
            color: #a0d2ff;
            max-width: 800px;
            margin: 0 auto;
        }

        .game-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 30px;
        }

        .game-area {
            flex: 1;
            min-width: 300px;
            max-width: 800px;
            position: relative;
        }

        .game-ui {
            flex: 0 0 300px;
            background: rgba(15, 15, 50, 0.85);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #9c88ff;
            box-shadow: 0 0 20px rgba(156, 136, 255, 0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        canvas {
            display: block;
            background: #000;
            border-radius: 10px;
            border: 3px solid #00a8ff;
            box-shadow: 0 0 30px rgba(0, 168, 255, 0.4);
            width: 100%;
            background: linear-gradient(to bottom, #000011, #000022);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-box {
            background: rgba(0, 40, 80, 0.7);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #00a8ff;
        }

        .stat-title {
            font-size: 0.9rem;
            color: #9c88ff;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00f3ff;
        }

        .controls-panel {
            background: rgba(0, 30, 60, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00a8ff;
        }

        .controls-panel h3 {
            color: #00f3ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .control-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(0, 20, 40, 0.5);
            border-radius: 5px;
        }

        .key {
            background: #222;
            color: #00f3ff;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            border: 1px solid #00a8ff;
            min-width: 40px;
            text-align: center;
        }

        .buttons-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .game-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .start-btn {
            background: linear-gradient(to right, #00a8ff, #0097e6);
            color: white;
        }

        .start-btn:hover {
            background: linear-gradient(to right, #0097e6, #00a8ff);
            box-shadow: 0 0 15px rgba(0, 168, 255, 0.7);
            transform: translateY(-3px);
        }

        .pause-btn {
            background: linear-gradient(to right, #fbc531, #e1b12c);
            color: #2c3e50;
        }

        .pause-btn:hover {
            background: linear-gradient(to right, #e1b12c, #fbc531);
            box-shadow: 0 0 15px rgba(251, 197, 49, 0.7);
            transform: translateY(-3px);
        }

        .reset-btn {
            background: linear-gradient(to right, #e84118, #c23616);
            color: white;
        }

        .reset-btn:hover {
            background: linear-gradient(to right, #c23616, #e84118);
            box-shadow: 0 0 15px rgba(232, 65, 24, 0.7);
            transform: translateY(-3px);
        }

        .instructions {
            background: rgba(15, 15, 50, 0.85);
            border-radius: 15px;
            padding: 25px;
            width: 100%;
            max-width: 1200px;
            margin-top: 10px;
            border: 2px solid #9c88ff;
            box-shadow: 0 0 20px rgba(156, 136, 255, 0.3);
        }

        .instructions h2 {
            color: #00f3ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions p {
            line-height: 1.6;
            margin-bottom: 15px;
            color: #a0d2ff;
        }

        .instructions ul {
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
            color: #a0d2ff;
        }

        .instructions strong {
            color: #00f3ff;
        }

        .mobile-controls {
            display: none;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
        }

        .mobile-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 168, 255, 0.7);
            border: 2px solid #00f3ff;
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
            user-select: none;
        }

        .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 10px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .game-over-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .game-over-content {
            background: linear-gradient(to bottom right, #0a0a2a, #1a1a4a);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #00a8ff;
            box-shadow: 0 0 40px rgba(0, 168, 255, 0.6);
            max-width: 500px;
            width: 90%;
        }

        .game-over-content h2 {
            font-size: 3rem;
            color: #ff3f34;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 63, 52, 0.7);
        }

        .game-over-content h3 {
            font-size: 2rem;
            color: #00f3ff;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 4rem;
            color: #fbc531;
            margin: 20px 0;
            text-shadow: 0 0 15px rgba(251, 197, 49, 0.8);
        }

        @media (max-width: 1100px) {
            .game-container {
                flex-direction: column;
                align-items: center;
            }
            
            .game-ui {
                width: 100%;
                max-width: 800px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls-list {
                grid-template-columns: 1fr;
            }
            
            .mobile-controls {
                display: flex;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .game-over-content h2 {
                font-size: 2.2rem;
            }
            
            .final-score {
                font-size: 3rem;
            }
            
            .mobile-btn {
                width: 60px;
                height: 60px;
                font-size: 1.2rem;
            }
        }

        /* 星空背景效果 */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- 動態星空背景 -->
    <div class="stars" id="stars"></div>

    <!-- 頁面標頭 -->
    <header class="header">
        <h1><i class="fas fa-rocket"></i> 星際保衛者</h1>
        <p>控制你的飛船，抵禦外星敵人入侵，保衛銀河系！在無盡的太空戰場中生存下來，創造最高分紀錄。</p>
    </header>

    <!-- 遊戲主容器 -->
    <div class="game-container">
        <!-- 遊戲區域 -->
        <div class="game-area">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            
            <!-- 遊戲結束畫面 -->
            <div class="game-over-screen" id="gameOverScreen">
                <div class="game-over-content">
                    <h2>遊戲結束</h2>
                    <h3>最終分數</h3>
                    <div class="final-score" id="finalScore">0</div>
                    <p>點擊下方按鈕重新開始遊戲</p>
                    <button class="game-btn start-btn" id="restartBtn" style="margin-top: 20px;">
                        <i class="fas fa-redo"></i> 重新開始
                    </button>
                </div>
            </div>
        </div>

        <!-- 遊戲UI面板 -->
        <div class="game-ui">
            <!-- 遊戲狀態 -->
            <div class="stats-panel">
                <div class="stat-box">
                    <div class="stat-title">分數</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">等級</div>
                    <div class="stat-value" id="level">1</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">生命值</div>
                    <div class="stat-value" id="lives">3</div>
                </div>
                <div class="stat-box">
                    <div class="stat-title">敵人數量</div>
                    <div class="stat-value" id="enemies">0</div>
                </div>
            </div>

            <!-- 遊戲控制按鈕 -->
            <div class="buttons-panel">
                <button class="game-btn start-btn" id="startBtn">
                    <i class="fas fa-play"></i> 開始遊戲
                </button>
                <button class="game-btn pause-btn" id="pauseBtn">
                    <i class="fas fa-pause"></i> 暫停遊戲
                </button>
                <button class="game-btn reset-btn" id="resetBtn">
                    <i class="fas fa-power-off"></i> 重新開始
                </button>
            </div>

            <!-- 控制說明 -->
            <div class="controls-panel">
                <h3><i class="fas fa-gamepad"></i> 遊戲控制</h3>
                <div class="controls-list">
                    <div class="control-item">
                        <div class="key">←</div>
                        <span>向左移動</span>
                    </div>
                    <div class="control-item">
                        <div class="key">→</div>
                        <span>向右移動</span>
                    </div>
                    <div class="control-item">
                        <div class="key">空格</div>
                        <span>發射子彈</span>
                    </div>
                    <div class="control-item">
                        <div class="key">P</div>
                        <span>暫停遊戲</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 手機控制按鈕 -->
    <div class="mobile-controls">
        <div class="mobile-btn" id="leftBtn"><i class="fas fa-arrow-left"></i></div>
        <div class="mobile-btn" id="shootBtn"><i class="fas fa-bullseye"></i></div>
        <div class="mobile-btn" id="rightBtn"><i class="fas fa-arrow-right"></i></div>
    </div>

    <!-- 遊戲說明 -->
    <div class="instructions">
        <h2><i class="fas fa-info-circle"></i> 遊戲說明</h2>
        <p>你是一艘太空飛船的駕駛員，任務是抵禦外星敵人的入侵。使用方向鍵控制飛船移動，空格鍵發射子彈摧毀敵人。</p>
        
        <h3>遊戲規則：</h3>
        <ul>
            <li>摧毀敵人可以獲得<strong>10分</strong></li>
            <li>每擊敗<strong>10個敵人</strong>，遊戲等級提升，敵人速度加快</li>
            <li>飛船有<strong>3點生命值</strong>，被敵人擊中會減少生命值</li>
            <li>當生命值歸零時，遊戲結束</li>
            <li>盡可能獲得高分，挑戰你的極限！</li>
        </ul>
        
        <h3>敵人類型：</h3>
        <ul>
            <li><strong>小型敵人</strong>：移動緩慢，生命值低</li>
            <li><strong中型敵人</strong>：移動中等，生命值中等</li>
            <li><strong>大型敵人</strong>：移動緩慢，生命值高</li>
        </ul>
    </div>

    <script>
        // 遊戲變數初始化
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const levelElement = document.getElementById('level');
        const livesElement = document.getElementById('lives');
        const enemiesElement = document.getElementById('enemies');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const restartBtn = document.getElementById('restartBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const shootBtn = document.getElementById('shootBtn');

        // 遊戲狀態
        let game = {
            running: false,
            paused: false,
            score: 0,
            level: 1,
            lives: 3,
            enemiesCount: 0,
            lastTime: 0,
            enemySpawnTimer: 0,
            gameOver: false
        };

        // 玩家飛船
        const player = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 80,
            width: 50,
            height: 70,
            speed: 6,
            color: '#00a8ff',
            bulletCooldown: 0,
            bullets: []
        };

        // 敵人陣列
        let enemies = [];
        // 特效陣列（爆炸等）
        let effects = [];
        // 星星陣列（背景）
        let stars = [];

        // 鍵盤狀態
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ' ': false
        };

        // 初始化星星背景
        function initStars() {
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 0.5,
                    speed: Math.random() * 0.5 + 0.2,
                    opacity: Math.random() * 0.8 + 0.2
                });
            }
        }

        // 繪製星星背景
        function drawStars() {
            stars.forEach(star => {
                ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                
                // 移動星星
                star.y += star.speed;
                if (star.y > canvas.height) {
                    star.y = 0;
                    star.x = Math.random() * canvas.width;
                }
            });
        }

        // 繪製玩家飛船
        function drawPlayer() {
            // 飛船主體
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.moveTo(player.x + player.width/2, player.y);
            ctx.lineTo(player.x + player.width, player.y + player.height/2);
            ctx.lineTo(player.x + player.width, player.y + player.height);
            ctx.lineTo(player.x, player.y + player.height);
            ctx.lineTo(player.x, player.y + player.height/2);
            ctx.closePath();
            ctx.fill();
            
            // 飛船細節
            ctx.fillStyle = '#00f3ff';
            ctx.fillRect(player.x + player.width/2 - 5, player.y + 10, 10, 15);
            
            // 引擎效果
            ctx.fillStyle = '#ff9f1a';
            ctx.beginPath();
            ctx.ellipse(player.x + player.width/2, player.y + player.height + 5, 10, 5, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        // 玩家子彈類
        class Bullet {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 5;
                this.height = 15;
                this.speed = 10;
                this.color = '#00f3ff';
            }
            
            update() {
                this.y -= this.speed;
                return this.y > 0;
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                
                // 子彈光暈效果
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 10;
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.shadowBlur = 0;
            }
        }

        // 敵人類
        class Enemy {
            constructor(type) {
                this.type = type;
                
                if (type === 'small') {
                    this.width = 30;
                    this.height = 30;
                    this.speed = 2 + game.level * 0.2;
                    this.color = '#9c88ff';
                    this.health = 1;
                    this.points = 10;
                } else if (type === 'medium') {
                    this.width = 50;
                    this.height = 50;
                    this.speed = 1.5 + game.level * 0.15;
                    this.color = '#fbc531';
                    this.health = 2;
                    this.points = 20;
                } else { // large
                    this.width = 70;
                    this.height = 70;
                    this.speed = 1 + game.level * 0.1;
                    this.color = '#e84118';
                    this.health = 3;
                    this.points = 30;
                }
                
                this.x = Math.random() * (canvas.width - this.width);
                this.y = -this.height;
            }
            
            update() {
                this.y += this.speed;
                return this.y < canvas.height + this.height;
            }
            
            draw() {
                // 敵人生體
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.ellipse(this.x + this.width/2, this.y + this.height/2, this.width/2, this.height/2, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // 敵人細節
                ctx.fillStyle = '#222';
                ctx.beginPath();
                ctx.arc(this.x + this.width/2, this.y + this.height/3, this.width/6, 0, Math.PI * 2);
                ctx.fill();
                
                // 敵人光暈
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.ellipse(this.x + this.width/2, this.y + this.height/2, this.width/2, this.height/2, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // 顯示生命值（大型敵人才顯示）
                if (this.type === 'large') {
                    ctx.fillStyle = '#fff';
                    ctx.font = '12px Arial';
                    ctx.fillText(`HP: ${this.health}`, this.x + this.width/2 - 15, this.y - 5);
                }
            }
            
            hit() {
                this.health--;
                return this.health <= 0;
            }
        }

        // 爆炸效果類
        class Explosion {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.radius = 5;
                this.maxRadius = 25;
                this.growth = 2;
                this.opacity = 1;
                this.fade = 0.05;
            }
            
            update() {
                this.radius += this.growth;
                this.opacity -= this.fade;
                return this.opacity > 0;
            }
            
            draw() {
                ctx.globalAlpha = this.opacity;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // 爆炸外圍
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.stroke();
                
                ctx.globalAlpha = 1;
            }
        }

        // 生成敵人
        function spawnEnemy() {
            const types = ['small', 'medium', 'large'];
            const weights = [0.5, 0.35, 0.15];
            
            let random = Math.random();
            let cumulativeWeight = 0;
            let selectedType = 'small';
            
            for (let i = 0; i < types.length; i++) {
                cumulativeWeight += weights[i];
                if (random <= cumulativeWeight) {
                    selectedType = types[i];
                    break;
                }
            }
            
            enemies.push(new Enemy(selectedType));
            game.enemiesCount++;
        }

        // 更新遊戲狀態
        function updateGame(timestamp) {
            if (!game.running || game.paused || game.gameOver) return;
            
            const deltaTime = timestamp - game.lastTime || 0;
            game.lastTime = timestamp;
            
            // 更新玩家子彈冷卻
            if (player.bulletCooldown > 0) {
                player.bulletCooldown -= deltaTime;
            }
            
            // 處理玩家移動
            if (keys.ArrowLeft && player.x > 0) {
                player.x -= player.speed;
            }
            if (keys.ArrowRight && player.x < canvas.width - player.width) {
                player.x += player.speed;
            }
            
            // 處理射擊
            if (keys[' '] && player.bulletCooldown <= 0) {
                player.bullets.push(new Bullet(player.x + player.width/2 - 2.5, player.y));
                player.bulletCooldown = 300; // 300毫秒冷卻
            }
            
            // 更新子彈
            player.bullets = player.bullets.filter(bullet => {
                const isActive = bullet.update();
                if (!isActive) return false;
                
                // 檢查子彈與敵人的碰撞
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    if (bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y) {
                        
                        // 擊中敵人
                        const isDestroyed = enemy.hit();
                        
                        // 創建爆炸效果
                        effects.push(new Explosion(
                            enemy.x + enemy.width/2,
                            enemy.y + enemy.height/2,
                            enemy.color
                        ));
                        
                        if (isDestroyed) {
                            // 增加分數
                            game.score += enemy.points;
                            scoreElement.textContent = game.score;
                            
                            // 每10個敵人提升一個等級
                            if (game.score % 100 === 0) {
                                game.level++;
                                levelElement.textContent = game.level;
                            }
                            
                            // 從陣列中移除敵人
                            enemies.splice(i, 1);
                            game.enemiesCount--;
                        }
                        
                        // 移除子彈
                        return false;
                    }
                }
                
                return true;
            });
            
            // 更新敵人
            enemies = enemies.filter(enemy => {
                const isActive = enemy.update();
                if (!isActive) {
                    game.enemiesCount--;
                    return false;
                }
                
                // 檢查敵人與玩家的碰撞
                if (player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y) {
                    
                    // 創建爆炸效果
                    effects.push(new Explosion(
                        player.x + player.width/2,
                        player.y + player.height/2,
                        '#ff3f34'
                    ));
                    
                    // 減少生命值
                    game.lives--;
                    livesElement.textContent = game.lives;
                    
                    // 檢查遊戲結束
                    if (game.lives <= 0) {
                        gameOver();
                    }
                    
                    // 移除敵人
                    game.enemiesCount--;
                    return false;
                }
                
                return true;
            });
            
            // 更新特效
            effects = effects.filter(effect => effect.update());
            
            // 生成新敵人
            game.enemySpawnTimer += deltaTime;
            const spawnInterval = Math.max(500, 1500 - game.level * 50); // 隨等級增加生成速度
            if (game.enemySpawnTimer >= spawnInterval) {
                spawnEnemy();
                game.enemySpawnTimer = 0;
            }
            
            // 更新UI
            enemiesElement.textContent = game.enemiesCount;
        }

        // 繪製遊戲
        function drawGame() {
            // 清空畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製星空背景
            drawStars();
            
            // 繪製玩家
            drawPlayer();
            
            // 繪製子彈
            player.bullets.forEach(bullet => bullet.draw());
            
            // 繪製敵人
            enemies.forEach(enemy => enemy.draw());
            
            // 繪製特效
            effects.forEach(effect => effect.draw());
            
            // 繪製HUD
            drawHUD();
        }

        // 繪製HUD
        function drawHUD() {
            // 分數顯示
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(10, 10, 150, 60);
            
            ctx.fillStyle = '#00f3ff';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(`分數: ${game.score}`, 20, 35);
            ctx.fillText(`等級: ${game.level}`, 20, 60);
            
            // 生命值顯示
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width - 160, 10, 150, 40);
            
            ctx.fillStyle = '#ff3f34';
            ctx.font = 'bold 20px Arial';
            ctx.fillText(`生命值: ${game.lives}`, canvas.width - 150, 35);
            
            // 遊戲狀態顯示
            if (game.paused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(canvas.width/2 - 150, canvas.height/2 - 50, 300, 100);
                
                ctx.fillStyle = '#fbc531';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('遊戲暫停', canvas.width/2, canvas.height/2);
                ctx.font = '20px Arial';
                ctx.fillText('按 P 鍵繼續', canvas.width/2, canvas.height/2 + 30);
                ctx.textAlign = 'left';
            }
            
            if (!game.running && !game.gameOver) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                ctx.fillRect(canvas.width/2 - 150, canvas.height/2 - 50, 300, 100);
                
                ctx.fillStyle = '#00a8ff';
                ctx.font = 'bold 36px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('星際保衛者', canvas.width/2, canvas.height/2 - 10);
                ctx.font = '18px Arial';
                ctx.fillText('點擊開始遊戲按鈕', canvas.width/2, canvas.height/2 + 30);
                ctx.textAlign = 'left';
            }
        }

        // 遊戲循環
        function gameLoop(timestamp) {
            updateGame(timestamp);
            drawGame();
            requestAnimationFrame(gameLoop);
        }

        // 開始遊戲
        function startGame() {
            if (game.gameOver) {
                resetGame();
            }
            
            game.running = true;
            game.paused = false;
            game.gameOver = false;
            
            startBtn.innerHTML = '<i class="fas fa-play"></i> 遊戲進行中';
            startBtn.disabled = true;
            startBtn.style.opacity = 0.7;
            
            gameOverScreen.classList.remove('active');
        }

        // 暫停遊戲
        function pauseGame() {
            if (!game.running || game.gameOver) return;
            
            game.paused = !game.paused;
            pauseBtn.innerHTML = game.paused ? 
                '<i class="fas fa-play"></i> 繼續遊戲' : 
                '<i class="fas fa-pause"></i> 暫停遊戲';
        }

        // 重置遊戲
        function resetGame() {
            game = {
                running: false,
                paused: false,
                score: 0,
                level: 1,
                lives: 3,
                enemiesCount: 0,
                lastTime: 0,
                enemySpawnTimer: 0,
                gameOver: false
            };
            
            player.x = canvas.width / 2 - 25;
            player.y = canvas.height - 80;
            player.bullets = [];
            player.bulletCooldown = 0;
            
            enemies = [];
            effects = [];
            
            // 更新UI
            scoreElement.textContent = game.score;
            levelElement.textContent = game.level;
            livesElement.textContent = game.lives;
            enemiesElement.textContent = game.enemiesCount;
            
            startBtn.innerHTML = '<i class="fas fa-play"></i> 開始遊戲';
            startBtn.disabled = false;
            startBtn.style.opacity = 1;
            
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暫停遊戲';
            
            gameOverScreen.classList.remove('active');
        }

        // 遊戲結束
        function gameOver() {
            game.running = false;
            game.gameOver = true;
            
            finalScoreElement.textContent = game.score;
            gameOverScreen.classList.add('active');
            
            startBtn.innerHTML = '<i class="fas fa-play"></i> 開始遊戲';
            startBtn.disabled = false;
            startBtn.style.opacity = 1;
        }

        // 事件監聽
        window.addEventListener('keydown', (e) => {
            if (e.key in keys) {
                keys[e.key] = true;
                
                // 防止空格鍵滾動頁面
                if (e.key === ' ') {
                    e.preventDefault();
                }
            }
            
            // P 鍵暫停遊戲
            if (e.key === 'p' || e.key === 'P') {
                pauseGame();
            }
        });

        window.addEventListener('keyup', (e) => {
            if (e.key in keys) {
                keys[e.key] = false;
            }
        });

        // 按鈕事件
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', pauseGame);
        resetBtn.addEventListener('click', resetGame);
        restartBtn.addEventListener('click', startGame);

        // 觸摸控制（移動設備）
        leftBtn.addEventListener('touchstart', () => keys.ArrowLeft = true);
        leftBtn.addEventListener('touchend', () => keys.ArrowLeft = false);
        leftBtn.addEventListener('mousedown', () => keys.ArrowLeft = true);
        leftBtn.addEventListener('mouseup', () => keys.ArrowLeft = false);
        leftBtn.addEventListener('mouseleave', () => keys.ArrowLeft = false);

        rightBtn.addEventListener('touchstart', () => keys.ArrowRight = true);
        rightBtn.addEventListener('touchend', () => keys.ArrowRight = false);
        rightBtn.addEventListener('mousedown', () => keys.ArrowRight = true);
        rightBtn.addEventListener('mouseup', () => keys.ArrowRight = false);
        rightBtn.addEventListener('mouseleave', () => keys.ArrowRight = false);

        shootBtn.addEventListener('touchstart', () => keys[' '] = true);
        shootBtn.addEventListener('touchend', () => keys[' '] = false);
        shootBtn.addEventListener('mousedown', () => keys[' '] = true);
        shootBtn.addEventListener('mouseup', () => keys[' '] = false);
        shootBtn.addEventListener('mouseleave', () => keys[' '] = false);

        // 防止觸摸設備上的上下文菜單
        document.addEventListener('contextmenu', e => e.preventDefault());

        // 初始化遊戲
        function init() {
            initStars();
            resetGame();
            gameLoop();
            
            // 適配畫布大小
            function resizeCanvas() {
                const container = canvas.parentElement;
                const containerWidth = container.clientWidth;
                
                // 保持16:9的寬高比
                const aspectRatio = 800/600;
                let newWidth = containerWidth;
                let newHeight = containerWidth / aspectRatio;
                
                // 如果高度太大，則根據高度調整
                if (newHeight > window.innerHeight * 0.7) {
                    newHeight = window.innerHeight * 0.7;
                    newWidth = newHeight * aspectRatio;
                }
                
                canvas.style.width = newWidth + 'px';
                canvas.style.height = newHeight + 'px';
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        }

        // 頁面加載完成後初始化遊戲
        window.addEventListener('load', init);
    </script>
</body>
</html>